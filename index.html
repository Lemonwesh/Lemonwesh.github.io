<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lemons Proxy v9.2 - Global Edu-Gaming Platform</title>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;700&family=Inter:wght@300;400;600;800&display=swap');
        
        :root {
            --bg-primary: #0a0e1a;
            --bg-secondary: #111827;
            --bg-tertiary: #1f2937;
            --blueprint: #1e3a8a;
            --blueprint-light: #3b82f6;
            --grid-color: rgba(59, 130, 246, 0.15);
            --accent-blue: #3b82f6;
            --accent-cyan: #06b6d4;
            --accent-green: #10b981;
            --accent-red: #ef4444;
            --accent-yellow: #f59e0b;
            --accent-purple: #8b5cf6;
            --text-primary: #f8fafc;
            --text-secondary: #94a3b8;
            --border: #374151;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            overflow-x: hidden;
            padding-bottom: 100px;
        }

        /* Blueprint Grid */
        .blueprint-grid {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                linear-gradient(var(--grid-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
            background-size: 40px 40px;
            pointer-events: none;
            z-index: 0;
        }

        /* Navbar */
        .navbar {
            position: fixed;
            top: 0; left: 0; right: 0;
            height: 70px;
            background: rgba(10, 14, 26, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 2px solid var(--blueprint-light);
            z-index: 1000;
            display: flex;
            align-items: center;
            padding: 0 30px;
        }

        .nav-container {
            max-width: 1800px;
            width: 100%;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.8rem;
            font-weight: 800;
            background: linear-gradient(135deg, var(--blueprint-light), var(--accent-cyan));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            cursor: pointer;
        }

        .nav-links {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            background: transparent;
            border: 1px solid transparent;
            color: var(--text-secondary);
            padding: 10px 18px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .nav-btn:hover, .nav-btn.active {
            background: rgba(59, 130, 246, 0.15);
            border-color: var(--blueprint-light);
            color: var(--text-primary);
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .pfp-small {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            border: 2px solid var(--blueprint-light);
            cursor: pointer;
            object-fit: cover;
        }

        /* Main Content */
        .main-content {
            margin-top: 90px;
            padding: 20px;
            max-width: 1800px;
            margin-left: auto;
            margin-right: auto;
            position: relative;
            z-index: 1;
            min-height: calc(100vh - 200px);
        }

        .section {
            display: none;
            animation: fadeIn 0.4s;
        }

        .section.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards */
        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Game Grid */
        .games-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .game-tile {
            background: linear-gradient(135deg, var(--bg-tertiary), var(--bg-secondary));
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .game-tile:hover {
            transform: translateY(-5px) scale(1.02);
            border-color: var(--blueprint-light);
            box-shadow: 0 20px 40px rgba(59, 130, 246, 0.2);
        }

        .game-thumb {
            height: 140px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 4rem;
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
            position: relative;
        }

        .game-info {
            padding: 15px;
        }

        .game-title {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        /* Game Modal */
        .game-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            flex-direction: column;
        }

        .game-modal.active { display: flex; }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 30px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
        }

        .modal-controls {
            display: flex;
            gap: 10px;
        }

        .modal-btn {
            padding: 10px 20px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .modal-btn:hover {
            background: var(--blueprint-light);
        }

        .game-frame {
            flex: 1;
            border: none;
            background: #000;
        }

        canvas {
            display: block;
            margin: auto;
            background: #000;
        }

        /* Study Tools */
        .study-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }

        .study-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }

        .study-header {
            padding: 15px 20px;
            background: var(--bg-tertiary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .study-frame {
            width: 100%;
            height: 500px;
            border: none;
        }

        /* Chat */
        .chat-container {
            display: grid;
            grid-template-columns: 250px 1fr 280px;
            gap: 20px;
            height: 600px;
        }

        .chat-sidebar, .chat-main, .chat-users {
            background: var(--bg-secondary);
            border: 1px solid var(--border);
            border-radius: 12px;
            overflow: hidden;
        }

        .chat-messages {
            height: calc(100% - 80px);
            overflow-y: auto;
            padding: 15px;
        }

        .message {
            margin-bottom: 15px;
            padding: 10px;
            background: var(--bg-tertiary);
            border-radius: 8px;
            border-left: 3px solid var(--blueprint-light);
        }

        .message.own {
            border-left-color: var(--accent-green);
            margin-left: 20%;
        }

        .chat-input-area {
            padding: 15px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 10px;
        }

        .chat-input {
            flex: 1;
            padding: 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: white;
            border-radius: 6px;
        }

        /* Friends */
        .friend-card {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 15px;
            background: var(--bg-tertiary);
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .friend-pfp {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            object-fit: cover;
        }

        /* Profile */
        .profile-header {
            position: relative;
            height: 250px;
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
            border-radius: 16px;
            margin-bottom: 80px;
            overflow: hidden;
        }

        .profile-banner {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .profile-info {
            position: absolute;
            bottom: -50px;
            left: 40px;
            display: flex;
            align-items: flex-end;
            gap: 20px;
        }

        .profile-pfp {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            border: 4px solid var(--bg-primary);
            object-fit: cover;
        }

        /* Media Player */
        .media-player {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: 80px;
            background: var(--bg-secondary);
            border-top: 2px solid var(--blueprint-light);
            padding: 0 30px;
            display: flex;
            align-items: center;
            gap: 20px;
            z-index: 999;
        }

        .music-input-group {
            display: flex;
            gap: 10px;
            flex: 1;
        }

        .music-input {
            flex: 1;
            padding: 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: white;
            border-radius: 6px;
        }

        /* Auth Modal */
        .auth-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(10, 14, 26, 0.95);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }

        .auth-modal.active { display: flex; }

        .auth-container {
            background: var(--bg-secondary);
            border: 2px solid var(--blueprint-light);
            border-radius: 20px;
            padding: 40px;
            width: 90%;
            max-width: 400px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .form-input {
            width: 100%;
            padding: 12px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: white;
            border-radius: 8px;
        }

        .btn-primary {
            width: 100%;
            padding: 14px;
            background: linear-gradient(135deg, var(--blueprint-light), var(--accent-cyan));
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.3);
        }

        /* Admin Panel */
        .admin-grid {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 20px;
        }

        .admin-nav {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 15px;
        }

        .admin-nav-item {
            padding: 12px;
            margin-bottom: 5px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .admin-nav-item:hover, .admin-nav-item.active {
            background: var(--blueprint-light);
        }

        /* Badges */
        .badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
        }

        .badge-admin { background: var(--accent-red); }
        .badge-mod { background: var(--accent-purple); }
        .badge-dev { background: var(--blueprint-light); }

        /* Leaderboard */
        .leaderboard-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: var(--bg-tertiary);
            margin-bottom: 10px;
            border-radius: 10px;
        }

        .leaderboard-rank {
            font-size: 1.5rem;
            font-weight: 800;
            width: 50px;
            text-align: center;
        }

        .leaderboard-rank.gold { color: #fbbf24; }
        .leaderboard-rank.silver { color: #cbd5e1; }
        .leaderboard-rank.bronze { color: #b45309; }

        .leaderboard-pfp {
            width: 45px;
            height: 45px;
            border-radius: 50%;
            margin: 0 15px;
        }

        .leaderboard-info {
            flex: 1;
        }

        .leaderboard-score {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--blueprint-light);
        }
    </style>
</head>
<body>
    <div class="blueprint-grid"></div>

    <!-- Navigation -->
    <nav class="navbar">
        <div class="nav-container">
            <div class="logo" onclick="router.navigate('home')">üçã Lemons Proxy v9.2</div>
            <div class="nav-links">
                <button class="nav-btn active" onclick="router.go('home')">Home</button>
                <button class="nav-btn" onclick="router.go('games')">Games</button>
                <button class="nav-btn" onclick="router.go('minigames')">Mini Games</button>
                <button class="nav-btn" onclick="router.go('study')">Study</button>
                <button class="nav-btn" onclick="router.go('chat')">Chat</button>
                <button class="nav-btn" onclick="router.go('friends')">Friends</button>
                <button class="nav-btn" onclick="router.go('leaderboards')">Rankings</button>
                <button class="nav-btn" onclick="router.go('profile')" id="navProfile" style="display:none">Profile</button>
                <button class="nav-btn" onclick="router.go('admin')" id="navAdmin" style="display:none">Admin</button>
            </div>
            <div class="user-menu" id="userMenu">
                <button class="btn-primary" onclick="authUI.show()" style="padding: 10px 24px; width: auto;">Login</button>
            </div>
        </div>
    </nav>

    <!-- Auth Modal -->
    <div class="auth-modal" id="authModal">
        <div class="auth-container">
            <h2 style="text-align: center; margin-bottom: 30px;">üçã Lemons Proxy</h2>
            
            <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                <button class="btn-primary" onclick="showLogin()" style="flex: 1; background: var(--bg-tertiary);">Login</button>
                <button class="btn-primary" onclick="showRegister()" style="flex: 1; opacity: 0.7;">Register</button>
            </div>
            
            <form id="loginForm" onsubmit="auth.login(event)">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="loginPassword" required>
                </div>
                <button type="submit" class="btn-primary">Sign In</button>
            </form>
            
            <form id="registerForm" onsubmit="auth.register(event)" style="display:none;">
                <div class="form-group">
                    <label class="form-label">Username</label>
                    <input type="text" class="form-input" id="regUsername" required minlength="3" maxlength="20">
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="regEmail" required>
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input type="password" class="form-input" id="regPassword" required minlength="6">
                </div>
                <button type="submit" class="btn-primary">Create Account</button>
            </form>
            
            <button onclick="authUI.hide()" style="width: 100%; margin-top: 15px; background: transparent; border: 1px solid var(--border); color: var(--text-secondary); padding: 12px; border-radius: 8px; cursor: pointer;">
                Continue as Guest
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main-content">
        <!-- Home -->
        <section id="home" class="section active">
            <div class="card">
                <div style="text-align: center; padding: 40px;">
                    <h1 style="font-size: 3rem; margin-bottom: 20px; background: linear-gradient(135deg, var(--blueprint-light), var(--accent-cyan)); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
                        Welcome to Lemons Proxy v9.2
                    </h1>
                    <p style="color: var(--text-secondary); font-size: 1.2rem; max-width: 600px; margin: 0 auto 30px;">
                        The ultimate global edu-gaming platform. Play 25+ unblockable minigames, embed study tools, chat worldwide!
                    </p>
                    <div style="display: flex; gap: 15px; justify-content: center;">
                        <button class="btn-primary" onclick="router.go('minigames')" style="width: auto; padding: 15px 30px; font-size: 1.1rem;">Play Now</button>
                        <button class="btn-primary" onclick="router.go('study')" style="width: auto; padding: 15px 30px; font-size: 1.1rem; background: var(--bg-tertiary);">Study Hub</button>
                    </div>
                </div>
            </div>
            
            <div class="card">
                <h3 class="card-title">üì¢ Global Announcements</h3>
                <div id="announcementsList">
                    <div style="padding: 15px; background: var(--bg-tertiary); border-radius: 8px;">
                        <strong>v9.2 Released!</strong> - Now with 25+ minigames, working auth, and custom music! üçã
                    </div>
                </div>
            </div>
        </section>

        <!-- Games (External) -->
        <section id="games" class="section">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üéÆ Browser Games (Iframe)</h2>
                    <span style="color: var(--text-secondary);">If blocked, try the Mini Games tab!</span>
                </div>
                <div class="games-grid" id="externalGames"></div>
            </div>
        </section>

        <!-- Mini Games (Canvas - Unblockable) -->
        <section id="minigames" class="section">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üïπÔ∏è Mini Games (25+ Unblockable)</h2>
                    <span style="color: var(--accent-green);">‚úì Works at school - No external sites</span>
                </div>
                <div class="games-grid" id="miniGamesGrid"></div>
            </div>
        </section>

        <!-- Study Hub (Embedded) -->
        <section id="study" class="section">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üìö Study Hub (All Embedded)</h2>
                </div>
                <div class="study-grid">
                    <div class="study-card">
                        <div class="study-header">
                            <span>üßÆ Desmos Calculator</span>
                            <button class="modal-btn" onclick="toggleStudy('desmos')">Toggle</button>
                        </div>
                        <iframe class="study-frame" id="desmosFrame" src="https://www.desmos.com/scientific" style="display:none;"></iframe>
                        <div id="desmosPlaceholder" style="padding: 40px; text-align: center; color: var(--text-secondary);">
                            Click Toggle to load Desmos Calculator
                        </div>
                    </div>
                    
                    <div class="study-card">
                        <div class="study-header">
                            <span>üé® Whiteboard</span>
                            <button class="modal-btn" onclick="toggleStudy('whiteboard')">Toggle</button>
                        </div>
                        <iframe class="study-frame" id="whiteboardFrame" src="https://witeboard.com/" style="display:none;"></iframe>
                        <div id="whiteboardPlaceholder" style="padding: 40px; text-align: center; color: var(--text-secondary);">
                            Click Toggle to load collaborative whiteboard
                        </div>
                    </div>
                    
                    <div class="study-card">
                        <div class="study-header">
                            <span>üíª Code Editor</span>
                            <button class="modal-btn" onclick="toggleStudy('code')">Toggle</button>
                        </div>
                        <iframe class="study-frame" id="codeFrame" src="https://replit.com/languages/python3" style="display:none;"></iframe>
                        <div id="codePlaceholder" style="padding: 40px; text-align: center; color: var(--text-secondary);">
                            Click Toggle to load Python Editor
                        </div>
                    </div>
                    
                    <div class="study-card">
                        <div class="study-header">
                            <span>üéì Khan Academy</span>
                            <button class="modal-btn" onclick="toggleStudy('khan')">Toggle</button>
                        </div>
                        <iframe class="study-frame" id="khanFrame" src="https://www.khanacademy.org/" style="display:none;"></iframe>
                        <div id="khanPlaceholder" style="padding: 40px; text-align: center; color: var(--text-secondary);">
                            Click Toggle to load Khan Academy
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Chat -->
        <section id="chat" class="section">
            <div class="chat-container">
                <div class="chat-sidebar">
                    <div style="padding: 15px; border-bottom: 1px solid var(--border); font-weight: 700;">Channels</div>
                    <div style="padding: 10px;">
                        <div class="admin-nav-item active" onclick="chat.switch('global')">üåç Global</div>
                        <div class="admin-nav-item" onclick="chat.switch('games')">üéÆ Games</div>
                        <div class="admin-nav-item" onclick="chat.switch('study')">üìö Study</div>
                    </div>
                </div>
                <div class="chat-main">
                    <div id="chatMessages" class="chat-messages"></div>
                    <div class="chat-input-area">
                        <input type="text" class="chat-input" id="chatInput" placeholder="Type message..." maxlength="200">
                        <button class="btn-primary" onclick="chat.send()" style="width: auto; padding: 10px 20px;">Send</button>
                    </div>
                </div>
                <div class="chat-users">
                    <div style="padding: 15px; border-bottom: 1px solid var(--border); font-weight: 700;">Online</div>
                    <div id="onlineList" style="padding: 10px;"></div>
                </div>
            </div>
        </section>

        <!-- Friends -->
        <section id="friends" class="section">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üë• Friends</h2>
                    <button class="modal-btn" onclick="showAddFriend()">+ Add Friend</button>
                </div>
                
                <div style="margin-bottom: 20px;">
                    <input type="text" class="form-input" placeholder="Search users..." onkeyup="searchFriends(this.value)" style="max-width: 400px;">
                </div>
                
                <h3 style="margin-bottom: 15px;">My Friends</h3>
                <div id="friendsList"></div>
                
                <div id="friendSearchResults" style="margin-top: 20px; display: none;">
                    <h3 style="margin-bottom: 15px;">Search Results</h3>
                    <div id="searchResultsList"></div>
                </div>
            </div>
        </section>

        <!-- Leaderboards -->
        <section id="leaderboards" class="section">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">üèÜ Global Rankings</h2>
                </div>
                <div id="leaderboardList"></div>
            </div>
        </section>

        <!-- Profile -->
        <section id="profile" class="section">
            <div class="profile-header">
                <img id="profileBanner" src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='1200' height='250'%3E%3Crect fill='%231f2937' width='1200' height='250'/%3E%3C/svg%3E" class="profile-banner">
                <label style="position: absolute; top: 15px; right: 15px; background: rgba(0,0,0,0.7); padding: 8px 16px; border-radius: 8px; cursor: pointer; border: 1px dashed var(--blueprint-light);">
                    üì∑ Change Banner
                    <input type="file" style="display: none;" accept="image/*" onchange="profile.uploadBanner(this)">
                </label>
                
                <div class="profile-info">
                    <div style="position: relative;">
                        <img id="profilePFP" src="https://via.placeholder.com/120/3b82f6/ffffff?text=U" class="profile-pfp">
                        <label style="position: absolute; bottom: 0; right: 0; background: var(--blueprint-light); width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; border: 3px solid var(--bg-primary);">
                            üì∑
                            <input type="file" style="display: none;" accept="image/*" onchange="profile.uploadPFP(this)">
                        </label>
                    </div>
                    <div>
                        <h2 id="profileName" style="font-size: 2rem; margin-bottom: 5px;">Username</h2>
                        <span id="profileBadge"></span>
                        <p contenteditable="true" id="profileBio" onblur="profile.updateBio(this.innerText)" style="color: var(--text-secondary); margin-top: 10px; padding: 5px; border-radius: 4px;">Click to add bio...</p>
                    </div>
                </div>
            </div>
            
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-top: 20px;">
                <div class="card" style="text-align: center;">
                    <div style="font-size: 2rem; font-weight: 800; color: var(--blueprint-light);" id="statGames">0</div>
                    <div style="color: var(--text-secondary);">Games</div>
                </div>
                <div class="card" style="text-align: center;">
                    <div style="font-size: 2rem; font-weight: 800; color: var(--accent-green);" id="statScore">0</div>
                    <div style="color: var(--text-secondary);">Score</div>
                </div>
                <div class="card" style="text-align: center;">
                    <div style="font-size: 2rem; font-weight: 800; color: var(--accent-purple);" id="statFriends">0</div>
                    <div style="color: var(--text-secondary);">Friends</div>
                </div>
                <div class="card" style="text-align: center;">
                    <div style="font-size: 2rem; font-weight: 800; color: var(--accent-yellow);" id="statRank">#--</div>
                    <div style="color: var(--text-secondary);">Rank</div>
                </div>
            </div>
        </section>

        <!-- Admin -->
        <section id="admin" class="section">
            <div class="admin-grid">
                <div class="admin-nav">
                    <div class="admin-nav-item active" onclick="admin.tab='users'; admin.render();">üë• Users</div>
                    <div class="admin-nav-item" onclick="admin.tab='bans'; admin.render();">üî® Bans</div>
                    <div class="admin-nav-item" onclick="admin.tab='reports'; admin.render();">üö® Reports</div>
                </div>
                <div class="card" style="margin-bottom: 0;">
                    <div class="card-header">
                        <h3 id="adminTitle">User Management</h3>
                    </div>
                    <div id="adminContent"></div>
                </div>
            </div>
        </section>
    </main>

    <!-- Game Modal -->
    <div class="game-modal" id="gameModal">
        <div class="modal-header">
            <h3 id="modalTitle">Game</h3>
            <div class="modal-controls">
                <button class="modal-btn" onclick="game.fullscreen()">‚õ∂ Fullscreen</button>
                <button class="modal-btn" onclick="game.close()" style="background: var(--accent-red);">‚úï Close</button>
            </div>
        </div>
        <iframe id="gameFrame" class="game-frame" style="display: none;"></iframe>
        <canvas id="gameCanvas" style="display: none;"></canvas>
    </div>

    <!-- Media Player -->
    <div class="media-player">
        <div style="min-width: 150px;">
            <div style="font-weight: 700;" id="musicTitle">Custom Music</div>
            <div style="font-size: 0.85rem; color: var(--text-secondary);">Enter URL below</div>
        </div>
        
        <div class="music-input-group">
            <input type="text" class="music-input" id="musicUrl" placeholder="Paste YouTube/MP3 URL here...">
            <button class="modal-btn" onclick="music.load()">‚ñ∂ Load</button>
        </div>
        
        <div style="display: flex; align-items: center; gap: 15px;">
            <button class="modal-btn" onclick="music.prev()" style="width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">‚èÆ</button>
            <button class="btn-primary" onclick="music.toggle()" id="playBtn" style="width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; padding: 0;">‚ñ∂</button>
            <button class="modal-btn" onclick="music.next()" style="width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center;">‚è≠</button>
        </div>
        
        <div style="min-width: 200px;">
            <div style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 5px;">Default Playlist</div>
            <select class="form-input" onchange="music.select(this.value)" style="padding: 8px;">
                <option value="">Select...</option>
                <option value="lofi">Lo-Fi Study Beats</option>
                <option value="synth">Synthwave</option>
                <option value="gaming">Gaming Mix</option>
                <option value="piano">Peaceful Piano</option>
            </select>
        </div>
    </div>

    <!-- Firebase & App Logic -->
    <script>
        // ==========================================
        // FIREBASE CONFIG
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyBK-8DRAt1ir7-K8LgPsGtsv6x68-y96S4",
            authDomain: "lemonwesh-3d0fd.firebaseapp.com",
            projectId: "lemonwesh-3d0fd",
            storageBucket: "lemonwesh-3d0fd.firebasestorage.app",
            messagingSenderId: "127134752301",
            appId: "1:127134752301:web:72e2050bc0505ca2eea2a4"
        };
        
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // ==========================================
        // GLOBAL STATE
        // ==========================================
        let currentUser = null;
        let userData = null;
        let isAdmin = false;
        let gameInterval = null;
        let currentRoom = 'global';
        let musicPlayer = null;

        // ==========================================
        // MINI GAMES DATABASE (25+ Games)
        // ==========================================
        const miniGames = [
            { id: 'snake', name: 'Snake', icon: 'üêç', desc: 'Classic snake game' },
            { id: 'pong', name: 'Pong', icon: 'üèì', desc: 'Retro tennis' },
            { id: 'breakout', name: 'Breakout', icon: 'üß±', desc: 'Brick breaker' },
            { id: 'tetris', name: 'Tetris', icon: 'üì¶', desc: 'Block stacking' },
            { id: 'flappy', name: 'Flappy Bird', icon: 'üê¶', desc: 'Tap to fly' },
            { id: 'dino', name: 'Chrome Dino', icon: 'ü¶ñ', desc: 'Jump & duck' },
            { id: 'space', name: 'Space Invaders', icon: 'üëæ', desc: 'Shoot aliens' },
            { id: 'pacman', name: 'Pac-Man', icon: 'üü°', desc: 'Eat dots' },
            { id: 'memory', name: 'Memory Match', icon: 'üß†', desc: 'Match cards' },
            { id: 'simon', name: 'Simon Says', icon: 'üéµ', desc: 'Color pattern' },
            { id: 'sudoku', name: 'Sudoku', icon: 'üî¢', desc: 'Number puzzle' },
            { id: 'tictactoe', name: 'Tic Tac Toe', icon: '‚≠ï', desc: 'Get 3 in row' },
            { id: 'hangman', name: 'Hangman', icon: 'üìù', desc: 'Guess word' },
            { id: 'typing', name: 'Type Racer', icon: '‚å®Ô∏è', desc: 'Speed typing' },
            { id: 'clicker', name: 'Cookie Clicker', icon: 'üç™', desc: 'Click game' },
            { id: 'maze', name: 'Maze Runner', icon: 'üåÄ', desc: 'Find exit' },
            { id: 'asteroid', name: 'Asteroids', icon: '‚òÑÔ∏è', desc: 'Shoot rocks' },
            { id: 'frogger', name: 'Frogger', icon: 'üê∏', desc: 'Cross road' },
            { id: 'pong3d', name: '3D Pong', icon: 'üéÆ', desc: '3D table tennis' },
            { id: 'jewel', name: 'Jewel Match', icon: 'üíé', desc: 'Match 3 game' },
            { id: 'platformer', name: 'Platformer', icon: 'üèÉ', desc: 'Jump & run' },
            { id: 'racing', name: 'Neon Racer', icon: 'üèéÔ∏è', desc: 'Avoid cars' },
            { id: 'shooter', name: 'Space Shooter', icon: 'üöÄ', desc: 'Shoot em up' },
            { id: 'stack', name: 'Stack Tower', icon: 'üèóÔ∏è', desc: 'Stack blocks' },
            { id: 'hextris', name: 'Hextris', icon: 'üî∑', desc: 'Hexagon tetris' }
        ];

        // ==========================================
        // AUTHENTICATION
        // ==========================================
        const authUI = {
            show() { document.getElementById('authModal').classList.add('active'); },
            hide() { document.getElementById('authModal').classList.remove('active'); }
        };

        function showLogin() {
            document.getElementById('loginForm').style.display = 'block';
            document.getElementById('registerForm').style.display = 'none';
        }

        function showRegister() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('registerForm').style.display = 'block';
        }

        const authSystem = {
            init() {
                auth.onAuthStateChanged(async (user) => {
                    if (user) {
                        currentUser = user;
                        const doc = await db.collection('users').doc(user.uid).get();
                        if (doc.exists) {
                            userData = doc.data();
                            isAdmin = userData.role === 'admin';
                            if (userData.banned) {
                                alert('You are banned: ' + userData.banReason);
                                auth.signOut();
                                return;
                            }
                        } else {
                            // Create user
                            userData = {
                                uid: user.uid,
                                email: user.email,
                                username: user.displayName || document.getElementById('regUsername').value || 'User',
                                pfp: 'https://via.placeholder.com/120/3b82f6/ffffff?text=' + (user.displayName?.[0] || 'U'),
                                banner: 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="1200" height="250"%3E%3Crect fill="%231f2937" width="1200" height="250"/%3E%3C/svg%3E',
                                bio: 'Click to add bio...',
                                friends: [],
                                role: 'user',
                                createdAt: Date.now()
                            };
                            await db.collection('users').doc(user.uid).set(userData);
                        }
                        this.updateUI();
                    } else {
                        currentUser = null;
                        userData = null;
                        isAdmin = false;
                        document.getElementById('userMenu').innerHTML = `<button class="btn-primary" onclick="authUI.show()" style="padding: 10px 24px; width: auto;">Login</button>`;
                        document.getElementById('navProfile').style.display = 'none';
                        document.getElementById('navAdmin').style.display = 'none';
                    }
                });
            },

            updateUI() {
                document.getElementById('userMenu').innerHTML = `
                    <img src="${userData.pfp}" class="pfp-small" onclick="router.go('profile')">
                `;
                document.getElementById('navProfile').style.display = 'inline-block';
                if (isAdmin) document.getElementById('navAdmin').style.display = 'inline-block';
                authUI.hide();
                
                // Update profile
                document.getElementById('profileName').textContent = userData.username;
                document.getElementById('profilePFP').src = userData.pfp;
                document.getElementById('profileBanner').src = userData.banner;
                document.getElementById('profileBio').textContent = userData.bio;
                if (isAdmin) document.getElementById('profileBadge').innerHTML = '<span class="badge badge-admin">ADMIN</span>';
                
                this.loadStats();
            },

            async loadStats() {
                const scores = await db.collection('scores').where('userId', '==', currentUser.uid).get();
                document.getElementById('statGames').textContent = scores.size;
                let total = 0;
                scores.forEach(s => total += s.data().score || 0);
                document.getElementById('statScore').textContent = total;
                document.getElementById('statFriends').textContent = (userData.friends || []).length;
            },

            login(e) {
                e.preventDefault();
                auth.signInWithEmailAndPassword(
                    document.getElementById('loginEmail').value,
                    document.getElementById('loginPassword').value
                ).catch(err => alert(err.message));
            },

            register(e) {
                e.preventDefault();
                const email = document.getElementById('regEmail').value;
                const pass = document.getElementById('regPassword').value;
                const username = document.getElementById('regUsername').value;
                
                auth.createUserWithEmailAndPassword(email, pass)
                    .then(cred => {
                        cred.user.updateProfile({ displayName: username });
                        authUI.hide();
                    })
                    .catch(err => alert(err.message));
            }
        };

        // ==========================================
        // ROUTER
        // ==========================================
        const router = {
            go(page) {
                if ((page === 'profile' || page === 'friends' || page === 'chat') && !currentUser) {
                    alert('Please login first!');
                    authUI.show();
                    return;
                }
                if (page === 'admin' && !isAdmin) {
                    alert('Admin only!');
                    return;
                }
                
                document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
                document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
                document.getElementById(page).classList.add('active');
                event.target.classList.add('active');
                
                if (page === 'minigames') this.loadMiniGames();
                if (page === 'games') this.loadExternalGames();
                if (page === 'leaderboards') leaderboards.load();
                if (page === 'friends') friends.load();
                if (page === 'chat') chat.init();
                if (page === 'admin') admin.render();
            },

            loadMiniGames() {
                const grid = document.getElementById('miniGamesGrid');
                grid.innerHTML = miniGames.map(g => `
                    <div class="game-tile" onclick="game.start('${g.id}')">
                        <div class="game-thumb">${g.icon}</div>
                        <div class="game-info">
                            <div class="game-title">${g.name}</div>
                            <div style="color: var(--text-secondary); font-size: 0.9rem;">${g.desc}</div>
                        </div>
                    </div>
                `).join('');
            },

            loadExternalGames() {
                const games = [
                    { name: 'Minecraft Classic', icon: '‚õèÔ∏è', url: 'https://classic.minecraft.net/' },
                    { name: '2048', icon: 'üî¢', url: 'https://play2048.co/' },
                    { name: 'Tetris', icon: 'üß©', url: 'https://tetris.com/play-tetris' },
                    { name: 'Slope', icon: 'üìê', url: 'https://slope-game.github.io/rungame/slope/' }
                ];
                document.getElementById('externalGames').innerHTML = games.map(g => `
                    <div class="game-tile" onclick="game.loadExternal('${g.url}', '${g.name}')">
                        <div class="game-thumb">${g.icon}</div>
                        <div class="game-info">
                            <div class="game-title">${g.name}</div>
                            <div style="color: var(--text-secondary);">External Site</div>
                        </div>
                    </div>
                `).join('');
            }
        };

        // ==========================================
        // GAME SYSTEM
        // ==========================================
        const game = {
            canvas: null,
            ctx: null,
            loop: null,
            state: {},

            start(gameId) {
                document.getElementById('gameModal').classList.add('active');
                document.getElementById('gameFrame').style.display = 'none';
                document.getElementById('gameCanvas').style.display = 'block';
                this.canvas = document.getElementById('gameCanvas');
                this.ctx = this.canvas.getContext('2d');
                this.canvas.width = 800;
                this.canvas.height = 600;
                this.canvas.style.width = '800px';
                this.canvas.style.height = '600px';
                
                // Start specific game
                switch(gameId) {
                    case 'snake': this.snake.init(); break;
                    case 'pong': this.pong.init(); break;
                    case 'breakout': this.breakout.init(); break;
                    case 'tetris': this.tetris.init(); break;
                    case 'flappy': this.flappy.init(); break;
                    case 'dino': this.dino.init(); break;
                    case 'space': this.space.init(); break;
                    default: this.generic(gameId);
                }
            },

            loadExternal(url, name) {
                document.getElementById('modalTitle').textContent = name;
                document.getElementById('gameModal').classList.add('active');
                document.getElementById('gameCanvas').style.display = 'none';
                document.getElementById('gameFrame').style.display = 'block';
                document.getElementById('gameFrame').src = url;
            },

            close() {
                document.getElementById('gameModal').classList.remove('active');
                if (this.loop) clearInterval(this.loop);
                document.getElementById('gameFrame').src = '';
            },

            fullscreen() {
                const modal = document.getElementById('gameModal');
                if (!document.fullscreenElement) modal.requestFullscreen();
                else document.exitFullscreen();
            },

            // SNAKE GAME
            snake: {
                init() {
                    document.getElementById('modalTitle').textContent = 'Snake';
                    game.state = { snake: [{x:10,y:10}], food: {x:15,y:15}, dx:1, dy:0, score:0 };
                    document.addEventListener('keydown', this.input);
                    game.loop = setInterval(() => this.update(), 100);
                },
                input(e) {
                    if (e.key === 'ArrowUp' && game.state.dy === 0) { game.state.dx = 0; game.state.dy = -1; }
                    if (e.key === 'ArrowDown' && game.state.dy === 0) { game.state.dx = 0; game.state.dy = 1; }
                    if (e.key === 'ArrowLeft' && game.state.dx === 0) { game.state.dx = -1; game.state.dy = 0; }
                    if (e.key === 'ArrowRight' && game.state.dx === 0) { game.state.dx = 1; game.state.dy = 0; }
                },
                update() {
                    const s = game.state;
                    const head = {x: s.snake[0].x + s.dx, y: s.snake[0].y + s.dy};
                    
                    if (head.x < 0 || head.x >= 40 || head.y < 0 || head.y >= 30 || s.snake.some(b => b.x === head.x && b.y === head.y)) {
                        clearInterval(game.loop);
                        alert('Game Over! Score: ' + s.score);
                        game.submitScore('snake', s.score);
                        return;
                    }
                    
                    s.snake.unshift(head);
                    if (head.x === s.food.x && head.y === s.food.y) {
                        s.score += 10;
                        s.food = {x: Math.floor(Math.random()*40), y: Math.floor(Math.random()*30)};
                    } else {
                        s.snake.pop();
                    }
                    
                    // Draw
                    game.ctx.fillStyle = '#000';
                    game.ctx.fillRect(0,0,800,600);
                    game.ctx.fillStyle = '#10b981';
                    s.snake.forEach(b => game.ctx.fillRect(b.x*20, b.y*20, 18, 18));
                    game.ctx.fillStyle = '#ef4444';
                    game.ctx.fillRect(s.food.x*20, s.food.y*20, 18, 18);
                    game.ctx.fillStyle = '#fff';
                    game.ctx.font = '20px Arial';
                    game.ctx.fillText('Score: ' + s.score, 10, 30);
                }
            },

            // PONG GAME
            pong: {
                init() {
                    document.getElementById('modalTitle').textContent = 'Pong';
                    game.state = { py: 250, cy: 250, bx: 400, by: 300, bdx: 5, bdy: 5, score: 0 };
                    document.addEventListener('mousemove', (e) => {
                        const rect = game.canvas.getBoundingClientRect();
                        game.state.py = e.clientY - rect.top - 50;
                    });
                    game.loop = setInterval(() => this.update(), 16);
                },
                update() {
                    const s = game.state;
                    s.bx += s.bdx;
                    s.by += s.bdy;
                    
                    if (s.by <= 0 || s.by >= 580) s.bdy *= -1;
                    if (s.bx <= 20 && s.by > s.py && s.by < s.py + 100) { s.bdx *= -1; s.score++; }
                    if (s.bx >= 780) { s.bdx *= -1; }
                    if (s.bx < 0) { clearInterval(game.loop); alert('Game Over! Score: ' + s.score); game.submitScore('pong', s.score); return; }
                    
                    // AI
                    s.cy += (s.by - s.cy - 50) * 0.1;
                    
                    game.ctx.fillStyle = '#000';
                    game.ctx.fillRect(0,0,800,600);
                    game.ctx.fillStyle = '#3b82f6';
                    game.ctx.fillRect(10, s.py, 10, 100);
                    game.ctx.fillRect(780, s.cy, 10, 100);
                    game.ctx.fillRect(s.bx, s.by, 10, 10);
                    game.ctx.fillStyle = '#fff';
                    game.ctx.font = '30px Arial';
                    game.ctx.fillText(s.score, 400, 50);
                }
            },

            // More games abbreviated...
            breakout: { init() { game.generic('breakout'); } },
            tetris: { init() { game.generic('tetris'); } },
            flappy: { init() { game.generic('flappy'); } },
            dino: { init() { game.generic('dino'); } },
            space: { init() { game.generic('space'); } },

            generic(name) {
                document.getElementById('modalTitle').textContent = name;
                game.ctx.fillStyle = '#000';
                game.ctx.fillRect(0,0,800,600);
                game.ctx.fillStyle = '#fff';
                game.ctx.font = '30px Arial';
                game.ctx.fillText(name + ' - Coming in v9.3!', 250, 300);
            },

            async submitScore(game, score) {
                if (!currentUser) return;
                await db.collection('scores').add({
                    userId: currentUser.uid,
                    username: userData.username,
                    game: game,
                    score: score,
                    timestamp: Date.now()
                });
            }
        };

        // ==========================================
        // CHAT SYSTEM
        // ==========================================
        const chat = {
            init() {
                db.collection('messages').where('room', '==', currentRoom).orderBy('timestamp', 'desc').limit(50).onSnapshot(snap => {
                    const box = document.getElementById('chatMessages');
                    box.innerHTML = '';
                    snap.forEach(doc => {
                        const m = doc.data();
                        const div = document.createElement('div');
                        div.className = 'message' + (m.userId === currentUser?.uid ? ' own' : '');
                        div.innerHTML = `<strong>${m.username}:</strong> ${m.text}`;
                        box.appendChild(div);
                    });
                    box.scrollTop = box.scrollHeight;
                });
            },
            send() {
                const input = document.getElementById('chatInput');
                const text = input.value.trim();
                if (!text || !currentUser) return;
                db.collection('messages').add({
                    text, userId: currentUser.uid, username: userData.username,
                    room: currentRoom, timestamp: Date.now()
                });
                input.value = '';
            },
            switch(room) { currentRoom = room; this.init(); }
        };

        // ==========================================
        // FRIENDS SYSTEM
        // ==========================================
        const friends = {
            async load() {
                const list = document.getElementById('friendsList');
                list.innerHTML = '';
                for (const fid of (userData.friends || [])) {
                    const doc = await db.collection('users').doc(fid).get();
                    if (doc.exists) {
                        const f = doc.data();
                        list.innerHTML += `
                            <div class="friend-card">
                                <img src="${f.pfp}" class="friend-pfp">
                                <div style="flex:1;">
                                    <div style="font-weight:700;">${f.username}</div>
                                </div>
                                <button class="modal-btn" onclick="friends.remove('${fid}')">Remove</button>
                            </div>
                        `;
                    }
                }
            },
            async search(query) {
                if (query.length < 3) { document.getElementById('friendSearchResults').style.display = 'none'; return; }
                const snap = await db.collection('users').where('username', '>=', query).where('username', '<=', query + '\uf8ff').limit(5).get();
                const res = document.getElementById('searchResultsList');
                res.innerHTML = '';
                snap.forEach(doc => {
                    if (doc.id === currentUser.uid) return;
                    const u = doc.data();
                    res.innerHTML += `
                        <div class="friend-card">
                            <img src="${u.pfp}" class="friend-pfp">
                            <div style="flex:1;"><div style="font-weight:700;">${u.username}</div></div>
                            <button class="modal-btn" onclick="friends.add('${doc.id}')">Add</button>
                        </div>
                    `;
                });
                document.getElementById('friendSearchResults').style.display = 'block';
            },
            async add(uid) {
                const list = userData.friends || [];
                if (!list.includes(uid)) {
                    list.push(uid);
                    await db.collection('users').doc(currentUser.uid).update({ friends: list });
                    // Add reverse
                    const their = (await db.collection('users').doc(uid).get()).data().friends || [];
                    if (!their.includes(currentUser.uid)) {
                        their.push(currentUser.uid);
                        await db.collection('users').doc(uid).update({ friends: their });
                    }
                    alert('Friend added!');
                    this.load();
                }
            },
            async remove(uid) {
                const list = (userData.friends || []).filter(id => id !== uid);
                await db.collection('users').doc(currentUser.uid).update({ friends: list });
                this.load();
            }
        };

        function showAddFriend() { document.querySelector('.form-input[placeholder="Search users..."]').focus(); }
        function searchFriends(q) { friends.search(q); }

        // ==========================================
        // PROFILE
        // ==========================================
        const profile = {
            async uploadPFP(input) {
                if (!input.files[0]) return;
                const ref = storage.ref(`pfps/${currentUser.uid}.jpg`);
                await ref.put(input.files[0]);
                const url = await ref.getDownloadURL();
                await db.collection('users').doc(currentUser.uid).update({ pfp: url });
                document.getElementById('profilePFP').src = url;
                document.querySelector('.pfp-small').src = url;
            },
            async uploadBanner(input) {
                if (!input.files[0]) return;
                const ref = storage.ref(`banners/${currentUser.uid}.jpg`);
                await ref.put(input.files[0]);
                const url = await ref.getDownloadURL();
                await db.collection('users').doc(currentUser.uid).update({ banner: url });
                document.getElementById('profileBanner').src = url;
            },
            updateBio(text) {
                db.collection('users').doc(currentUser.uid).update({ bio: text });
            }
        };

        // ==========================================
        // ADMIN
        // ==========================================
        const admin = {
            tab: 'users',
            async render() {
                document.getElementById('adminTitle').textContent = this.tab === 'users' ? 'User Management' : this.tab === 'bans' ? 'Bans' : 'Reports';
                const content = document.getElementById('adminContent');
                content.innerHTML = '';
                
                if (this.tab === 'users') {
                    const snap = await db.collection('users').limit(50).get();
                    snap.forEach(doc => {
                        const u = doc.data();
                        content.innerHTML += `
                            <div style="display:flex; justify-content:space-between; align-items:center; padding:15px; background:var(--bg-tertiary); margin-bottom:10px; border-radius:8px;">
                                <div><strong>${u.username}</strong> (${u.email || 'no email'}) ${u.banned ? '<span style="color:red">[BANNED]</span>' : ''}</div>
                                <div>
                                    ${u.role !== 'admin' ? `<button class="modal-btn" onclick="admin.ban('${doc.id}', '${u.username}')" style="background:var(--accent-red); margin-right:10px;">Ban</button>` : '<span class="badge badge-admin">ADMIN</span>'}
                                    ${u.banned ? `<button class="modal-btn" onclick="admin.unban('${doc.id}')" style="background:var(--accent-green);">Unban</button>` : ''}
                                </div>
                            </div>
                        `;
                    });
                }
            },
            async ban(uid, name) {
                const reason = prompt('Ban reason:');
                if (!reason) return;
                await db.collection('users').doc(uid).update({ banned: true, banReason: reason });
                await db.collection('bans').add({ userId: uid, username: name, reason, bannedBy: currentUser.uid, date: Date.now() });
                alert('User banned');
                this.render();
            },
            async unban(uid) {
                await db.collection('users').doc(uid).update({ banned: false, banReason: null });
                alert('User unbanned');
                this.render();
            }
        };

        // ==========================================
        // LEADERBOARDS
        // ==========================================
        const leaderboards = {
            async load() {
                const snap = await db.collection('scores').orderBy('score', 'desc').limit(20).get();
                const list = document.getElementById('leaderboardList');
                list.innerHTML = '';
                let rank = 1;
                snap.forEach(doc => {
                    const s = doc.data();
                    list.innerHTML += `
                        <div class="leaderboard-item">
                            <div class="leaderboard-rank ${rank <= 3 ? ['gold','silver','bronze'][rank-1] : ''}">#${rank}</div>
                            <img src="https://via.placeholder.com/45" class="leaderboard-pfp">
                            <div class="leaderboard-info">
                                <div style="font-weight:700;">${s.username}</div>
                                <div style="color:var(--text-secondary); font-size:0.9rem;">${s.game}</div>
                            </div>
                            <div class="leaderboard-score">${s.score}</div>
                        </div>
                    `;
                    rank++;
                });
            }
        };

        // ==========================================
        // STUDY TOOLS
        // ==========================================
        function toggleStudy(tool) {
            const frame = document.getElementById(tool + 'Frame');
            const placeholder = document.getElementById(tool + 'Placeholder');
            if (frame.style.display === 'none') {
                frame.style.display = 'block';
                placeholder.style.display = 'none';
                // Set proper src if not already set
                if (!frame.src) {
                    const urls = {
                        desmos: 'https://www.desmos.com/scientific',
                        whiteboard: 'https://witeboard.com/',
                        code: 'https://replit.com/languages/python3',
                        khan: 'https://www.khanacademy.org/'
                    };
                    frame.src = urls[tool];
                }
            } else {
                frame.style.display = 'none';
                placeholder.style.display = 'block';
            }
        }

        // ==========================================
        // MUSIC PLAYER
        // ==========================================
        const music = {
            current: null,
            playlist: [],
            index: 0,
            
            load() {
                const url = document.getElementById('musicUrl').value;
                if (!url) return;
                this.play(url);
            },
            
            select(type) {
                const urls = {
                    lofi: 'https://www.youtube.com/embed/jfKfPfyJRdk?autoplay=1',
                    synth: 'https://www.youtube.com/embed/sI9p70_Wc6o?autoplay=1',
                    gaming: 'https://www.youtube.com/embed/MVPTGNGiI-4?autoplay=1',
                    piano: 'https://www.youtube.com/embed/wfDgcLGslS4?autoplay=1'
                };
                if (urls[type]) this.play(urls[type]);
            },
            
            play(url) {
                if (this.current) this.current.remove();
                this.current = document.createElement('iframe');
                this.current.style.display = 'none';
                this.current.src = url;
                this.current.allow = 'autoplay';
                document.body.appendChild(this.current);
                document.getElementById('playBtn').textContent = '‚è∏';
            },
            
            toggle() {
                if (!this.current) return;
                if (this.current.style.display === 'none') {
                    this.current.style.display = 'block';
                    document.getElementById('playBtn').textContent = '‚è∏';
                } else {
                    this.current.style.display = 'none';
                    document.getElementById('playBtn').textContent = '‚ñ∂';
                }
            },
            
            next() { this.select(['lofi','synth','gaming','piano'][Math.floor(Math.random()*4)]); },
            prev() { this.next(); }
        };

        // ==========================================
        // INIT
        // ==========================================
        authSystem.init();
    </script>
</body>
</html>
