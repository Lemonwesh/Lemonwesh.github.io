<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lemons Proxy v9.3 - Global Platform</title>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-storage-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
        
        :root {
            --blueprint-bg: #1e3a5f;
            --blueprint-dark: #172554;
            --blueprint-light: #3b82f6;
            --grid-color: rgba(255, 255, 255, 0.15);
            --accent: #4ade80;
            --accent-warn: #fbbf24;
            --text: #ffffff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'JetBrains Mono', monospace;
            background: var(--blueprint-bg);
            color: var(--text);
            min-height: 100vh;
            position: relative;
        }

        /* VISIBLE Blueprint Grid */
        body::before {
            content: '';
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                linear-gradient(to right, var(--grid-color) 1px, transparent 1px),
                linear-gradient(to bottom, var(--grid-color) 1px, transparent 1px);
            background-size: 40px 40px;
            pointer-events: none;
            z-index: 0;
            border: 3px solid rgba(59, 130, 246, 0.5);
            box-sizing: border-box;
        }

        /* Corner Decorations */
        .corner {
            position: fixed;
            width: 60px; height: 60px;
            border: 3px solid var(--blueprint-light);
            z-index: 1;
            pointer-events: none;
        }
        .corner-tl { top: 20px; left: 20px; border-right: none; border-bottom: none; }
        .corner-tr { top: 20px; right: 20px; border-left: none; border-bottom: none; }
        .corner-bl { bottom: 20px; left: 20px; border-right: none; border-top: none; }
        .corner-br { bottom: 20px; right: 20px; border-left: none; border-top: none; }

        /* Navbar */
        .navbar {
            position: fixed;
            top: 0; left: 0; right: 0;
            background: rgba(30, 58, 95, 0.95);
            border-bottom: 3px dashed var(--blueprint-light);
            padding: 15px 30px;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .logo {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--accent);
            text-shadow: 0 0 10px rgba(74, 222, 128, 0.5);
            cursor: pointer;
        }

        .nav-links {
            display: flex;
            gap: 10px;
        }

        .nav-btn {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.3);
            color: white;
            padding: 8px 16px;
            cursor: pointer;
            font-family: inherit;
            transition: all 0.3s;
        }

        .nav-btn:hover, .nav-btn.active {
            background: var(--blueprint-light);
            border-color: var(--blueprint-light);
            transform: translateY(-2px);
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.5);
        }

        /* Main */
        .main {
            margin-top: 80px;
            padding: 20px;
            max-width: 1400px;
            margin-left: auto;
            margin-right: auto;
            position: relative;
            z-index: 10;
            padding-bottom: 100px;
        }

        .section { display: none; }
        .section.active { display: block; animation: fadeIn 0.3s; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Cards with Blueprint Style */
        .card {
            background: rgba(23, 37, 84, 0.8);
            border: 2px dashed rgba(255,255,255,0.3);
            padding: 25px;
            margin-bottom: 25px;
            position: relative;
        }

        .card::before {
            content: '';
            position: absolute;
            top: -2px; left: -2px;
            width: 20px; height: 20px;
            border-top: 3px solid var(--accent);
            border-left: 3px solid var(--accent);
        }

        .card::after {
            content: '';
            position: absolute;
            bottom: -2px; right: -2px;
            width: 20px; height: 20px;
            border-bottom: 3px solid var(--accent);
            border-right: 3px solid var(--accent);
        }

        .card-title {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: var(--accent);
            text-transform: uppercase;
            letter-spacing: 2px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* Game Grid */
        .game-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .game-tile {
            background: rgba(255,255,255,0.05);
            border: 2px solid rgba(255,255,255,0.2);
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .game-tile::before {
            content: '';
            position: absolute;
            top: 0; left: -100%;
            width: 100%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
            transition: left 0.5s;
        }

        .game-tile:hover::before {
            left: 100%;
        }

        .game-tile:hover {
            border-color: var(--accent);
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
        }

        .game-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }

        .game-name {
            font-weight: 700;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .game-desc {
            font-size: 0.85rem;
            color: rgba(255,255,255,0.7);
        }

        /* Game Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 2000;
            flex-direction: column;
        }

        .modal.active { display: flex; }

        .modal-header {
            background: var(--blueprint-bg);
            padding: 15px 20px;
            border-bottom: 2px dashed var(--blueprint-light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            color: var(--accent);
            font-size: 1.3rem;
            font-weight: 700;
        }

        .btn {
            background: var(--blueprint-light);
            border: none;
            color: white;
            padding: 8px 16px;
            cursor: pointer;
            font-family: inherit;
            margin-left: 10px;
        }

        .btn:hover {
            background: var(--accent);
            color: black;
        }

        .game-area {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            background: #000;
            position: relative;
        }

        canvas {
            background: #000;
            box-shadow: 0 0 30px rgba(59, 130, 246, 0.3);
        }

        /* Auth */
        .auth-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(30, 58, 95, 0.95);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }

        .auth-modal.active { display: flex; }

        .auth-box {
            background: var(--blueprint-dark);
            border: 3px dashed var(--blueprint-light);
            padding: 40px;
            width: 90%;
            max-width: 400px;
            position: relative;
        }

        .auth-box::before, .auth-box::after {
            content: '+';
            position: absolute;
            color: var(--accent);
            font-size: 2rem;
        }
        .auth-box::before { top: 10px; left: 10px; }
        .auth-box::after { bottom: 10px; right: 10px; }

        .input-group {
            margin-bottom: 20px;
        }

        .input-label {
            display: block;
            margin-bottom: 8px;
            color: var(--accent);
            font-size: 0.9rem;
            text-transform: uppercase;
        }

        .input {
            width: 100%;
            padding: 12px;
            background: rgba(0,0,0,0.3);
            border: 2px solid rgba(255,255,255,0.2);
            color: white;
            font-family: inherit;
            font-size: 1rem;
        }

        .input:focus {
            outline: none;
            border-color: var(--blueprint-light);
        }

        .btn-primary {
            width: 100%;
            padding: 15px;
            background: var(--accent);
            color: black;
            border: none;
            font-family: inherit;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
            letter-spacing: 2px;
        }

        .btn-primary:hover {
            background: var(--accent-warn);
            transform: translateY(-2px);
        }

        /* Chat */
        .chat-box {
            background: rgba(0,0,0,0.3);
            border: 2px dashed rgba(255,255,255,0.2);
            height: 400px;
            overflow-y: auto;
            padding: 15px;
            margin-bottom: 15px;
        }

        .msg {
            margin-bottom: 10px;
            padding: 10px;
            background: rgba(255,255,255,0.05);
            border-left: 3px solid var(--blueprint-light);
        }

        .msg-own {
            border-left-color: var(--accent);
            text-align: right;
        }

        /* Media Player */
        .player {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--blueprint-dark);
            border-top: 3px dashed var(--blueprint-light);
            padding: 15px;
            display: flex;
            align-items: center;
            gap: 20px;
            z-index: 100;
        }

        .player-input {
            flex: 1;
            padding: 10px;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            font-family: inherit;
        }

        /* Admin */
        .admin-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            margin-bottom: 10px;
            border: 1px solid rgba(255,255,255,0.1);
        }

        .badge {
            padding: 5px 10px;
            font-size: 0.8rem;
            margin-left: 10px;
        }

        .badge-admin { background: var(--accent-warn); color: black; }
        .badge-banned { background: #ef4444; }

        /* Leaderboard */
        .lb-item {
            display: flex;
            align-items: center;
            padding: 15px;
            background: rgba(255,255,255,0.05);
            margin-bottom: 10px;
            border-left: 4px solid var(--blueprint-light);
        }

        .lb-rank {
            font-size: 1.5rem;
            font-weight: 700;
            width: 50px;
            color: var(--accent);
        }

        .lb-name { flex: 1; font-weight: 700; }
        .lb-score { font-size: 1.3rem; color: var(--accent-warn); }

        /* Utility */
        .hidden { display: none !important; }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 10px 20px;
            background: rgba(255,255,255,0.1);
            border: 2px solid transparent;
            cursor: pointer;
            color: white;
            font-family: inherit;
        }
        
        .tab:hover, .tab.active {
            border-color: var(--accent);
            background: rgba(74, 222, 128, 0.1);
        }
    </style>
</head>
<body>
    <!-- Corner Decorations -->
    <div class="corner corner-tl"></div>
    <div class="corner corner-tr"></div>
    <div class="corner corner-bl"></div>
    <div class="corner corner-br"></div>

    <!-- Nav -->
    <nav class="navbar">
        <div class="logo" onclick="show('home')">üçã LEMONS PROXY v9.3</div>
        <div class="nav-links">
            <button class="nav-btn active" onclick="show('home')">Home</button>
            <button class="nav-btn" onclick="show('games')">Games</button>
            <button class="nav-btn" onclick="show('arcade')">Arcade (15)</button>
            <button class="nav-btn" onclick="show('study')">Study</button>
            <button class="nav-btn" onclick="show('chat')">Global Chat</button>
            <button class="nav-btn" onclick="show('leaderboard')">Rankings</button>
            <button class="nav-btn hidden" onclick="show('admin')" id="adminBtn">Admin</button>
        </div>
        <div id="userBox">
            <button class="btn" onclick="toggleAuth()">Login</button>
        </div>
    </nav>

    <!-- Auth Modal -->
    <div class="auth-modal" id="authModal">
        <div class="auth-box">
            <h2 style="text-align: center; margin-bottom: 30px; color: var(--accent);">üçã ACCESS PORTAL</h2>
            
            <div class="tabs">
                <button class="tab active" onclick="showAuth('login')">Login</button>
                <button class="tab" onclick="showAuth('register')">Register</button>
            </div>
            
            <form id="loginForm" onsubmit="doLogin(event)">
                <div class="input-group">
                    <label class="input-label">Username</label>
                    <input type="text" class="input" id="loginUser" required placeholder="Enter username">
                </div>
                <div class="input-group">
                    <label class="input-label">Password</label>
                    <input type="password" class="input" id="loginPass" required placeholder="Password">
                </div>
                <button type="submit" class="btn-primary">Access System</button>
            </form>
            
            <form id="regForm" onsubmit="doRegister(event)" style="display:none;">
                <div class="input-group">
                    <label class="input-label">Choose Username</label>
                    <input type="text" class="input" id="regUser" required minlength="3" maxlength="15" placeholder="3-15 characters">
                </div>
                <div class="input-group">
                    <label class="input-label">Password</label>
                    <input type="password" class="input" id="regPass" required minlength="6" placeholder="Min 6 characters">
                </div>
                <button type="submit" class="btn-primary">Create Account</button>
            </form>
        </div>
    </div>

    <!-- Main Content -->
    <main class="main">
        <!-- Home -->
        <section id="home" class="section active">
            <div class="card">
                <h1 class="card-title">üéÆ SYSTEM READY</h1>
                <p style="font-size: 1.1rem; line-height: 1.6;">
                    Welcome to Lemons Proxy v9.3. 15 unblocked minigames available immediately. 
                    No email required for login. Global chat and leaderboards active.
                </p>
                <div style="margin-top: 20px; display: flex; gap: 15px;">
                    <button class="btn" onclick="show('arcade')" style="font-size: 1.1rem; padding: 15px 30px;">PLAY NOW</button>
                    <button class="btn" onclick="show('study')">Study Tools</button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-title">üìä SYSTEM STATUS</div>
                <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px;">
                    <div style="text-align: center; padding: 20px; background: rgba(0,0,0,0.2);">
                        <div id="statGames" style="font-size: 2.5rem; color: var(--accent); font-weight: 700;">15</div>
                        <div>Active Games</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: rgba(0,0,0,0.2);">
                        <div id="statOnline" style="font-size: 2.5rem; color: var(--blueprint-light); font-weight: 700;">--</div>
                        <div>Users Online</div>
                    </div>
                    <div style="text-align: center; padding: 20px; background: rgba(0,0,0,0.2);">
                        <div style="font-size: 2.5rem; color: var(--accent-warn); font-weight: 700;">v9.3</div>
                        <div>System Version</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Games (External/Unblocked) -->
        <section id="games" class="section">
            <div class="card">
                <div class="card-title">üåê EXTERNAL GAMES</div>
                <p style="margin-bottom: 20px; color: rgba(255,255,255,0.8);">If blocked by school, use Arcade tab instead</p>
                <div class="game-grid" id="externalGames"></div>
            </div>
        </section>

        <!-- Arcade (15 Working Minigames) -->
        <section id="arcade" class="section">
            <div class="card">
                <div class="card-title">üïπÔ∏è ARCADE - 15 WORKING GAMES</div>
                <p style="margin-bottom: 20px; color: var(--accent);">‚úì All games run locally - Cannot be blocked</p>
                <div class="game-grid" id="arcadeGrid"></div>
            </div>
        </section>

        <!-- Study -->
        <section id="study" class="section">
            <div class="card">
                <div class="card-title">üìö STUDY MODULES</div>
                <div class="game-grid">
                    <div class="game-tile" onclick="openStudy('https://www.desmos.com/scientific')">
                        <div class="game-icon">üßÆ</div>
                        <div class="game-name">Calculator</div>
                        <div class="game-desc">Desmos Scientific</div>
                    </div>
                    <div class="game-tile" onclick="openStudy('https://witeboard.com/')">
                        <div class="game-icon">üé®</div>
                        <div class="game-name">Whiteboard</div>
                        <div class="game-desc">Collaborative Draw</div>
                    </div>
                    <div class="game-tile" onclick="openStudy('https://www.khanacademy.org/')">
                        <div class="game-icon">üéì</div>
                        <div class="game-name">Khan Academy</div>
                        <div class="game-desc">Free Education</div>
                    </div>
                    <div class="game-tile" onclick="openStudy('https://replit.com/languages/python3')">
                        <div class="game-icon">üíª</div>
                        <div class="game-name">Python IDE</div>
                        <div class="game-desc">Code Editor</div>
                    </div>
                </div>
            </div>
            <iframe id="studyFrame" style="width: 100%; height: 600px; border: 2px dashed var(--blueprint-light); margin-top: 20px; display: none; background: white;"></iframe>
        </section>

        <!-- Chat -->
        <section id="chat" class="section">
            <div class="card">
                <div class="card-title">üí¨ GLOBAL CHAT</div>
                <div class="chat-box" id="chatBox"></div>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="chatInput" class="input" placeholder="Enter message..." style="flex: 1;" maxlength="200">
                    <button class="btn" onclick="sendChat()">SEND</button>
                </div>
            </div>
        </section>

        <!-- Leaderboard -->
        <section id="leaderboard" class="section">
            <div class="card">
                <div class="card-title">üèÜ GLOBAL RANKINGS</div>
                <div id="leaderboardList"></div>
            </div>
        </section>

        <!-- Admin -->
        <section id="admin" class="section">
            <div class="card">
                <div class="card-title">üõ°Ô∏è ADMIN CONTROL</div>
                <div id="adminContent"></div>
            </div>
        </section>
    </main>

    <!-- Game Modal -->
    <div class="modal" id="gameModal">
        <div class="modal-header">
            <span class="modal-title" id="modalTitle">GAME</span>
            <div>
                <button class="btn" onclick="toggleFullscreen()">‚õ∂ Fullscreen</button>
                <button class="btn" onclick="closeGame()" style="background: #ef4444;">‚úï Close</button>
            </div>
        </div>
        <div class="game-area">
            <canvas id="gameCanvas" width="800" height="600"></canvas>
        </div>
    </div>

    <!-- Media Player -->
    <div class="player">
        <span style="color: var(--accent); font-weight: 700;">üéµ AUDIO:</span>
        <input type="text" class="player-input" id="musicUrl" placeholder="Paste YouTube/MP3 URL...">
        <button class="btn" onclick="playMusic()">PLAY</button>
        <button class="btn" onclick="stopMusic()">STOP</button>
    </div>

    <!-- Scripts -->
    <script>
        // ==========================================
        // FIREBASE CONFIG
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyBK-8DRAt1ir7-K8LgPsGtsv6x68-y96S4",
            authDomain: "lemonwesh-3d0fd.firebaseapp.com",
            projectId: "lemonwesh-3d0fd",
            storageBucket: "lemonwesh-3d0fd.firebasestorage.app",
            messagingSenderId: "127134752301",
            appId: "1:127134752301:web:72e2050bc0505ca2eea2a4"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // ==========================================
        // STATE
        // ==========================================
        let user = null;
        let userData = null;
        let isAdmin = false;
        let gameLoop = null;
        let currentGame = null;
        let musicFrame = null;

        // ==========================================
        // 15 WORKING MINIGAMES
        // ==========================================
        const games = [
            { id: 'snake', name: 'Snake', icon: 'üêç', desc: 'Eat food, grow long' },
            { id: 'pong', name: 'Pong', icon: 'üèì', desc: 'Classic tennis' },
            { id: 'tetris', name: 'Tetris', icon: 'üì¶', desc: 'Stack blocks' },
            { id: 'breakout', name: 'Breakout', icon: 'üß±', desc: 'Break bricks' },
            { id: 'flappy', name: 'Flappy Bird', icon: 'üê¶', desc: 'Tap to fly' },
            { id: 'dino', name: 'Dino Run', icon: 'ü¶ñ', desc: 'Jump & duck' },
            { id: 'space', name: 'Space Invaders', icon: 'üëæ', desc: 'Shoot aliens' },
            { id: 'pong2', name: 'Pong AI', icon: 'üéÆ', desc: 'vs Computer' },
            { id: 'memory', name: 'Memory', icon: 'üß†', desc: 'Match pairs' },
            { id: 'simon', name: 'Simon Says', icon: 'üéµ', desc: 'Color pattern' },
            { id: 'tictactoe', name: 'Tic Tac Toe', icon: '‚≠ï', desc: 'Get 3 in row' },
            { id: 'clicker', name: 'Clicker', icon: 'üç™', desc: 'Click fast' },
            { id: 'maze', name: 'Maze', icon: 'üåÄ', desc: 'Find exit' },
            { id: 'pong3d', name: 'Neon Pong', icon: '‚ö°', desc: 'Glow edition' },
            { id: 'jumper', name: 'Jumper', icon: 'ü¶ò', desc: 'Jump up' }
        ];

        // ==========================================
        // AUTH (USERNAME ONLY - NO EMAIL!)
        // ==========================================
        function toggleAuth() {
            document.getElementById('authModal').classList.toggle('active');
        }

        function showAuth(type) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('loginForm').style.display = type === 'login' ? 'block' : 'none';
            document.getElementById('regForm').style.display = type === 'login' ? 'none' : 'block';
        }

        async function doLogin(e) {
            e.preventDefault();
            const username = document.getElementById('loginUser').value;
            const password = document.getElementById('loginPass').value;
            
            // Create pseudo-email from username
            const email = username + '@lemons.proxy';
            try {
                await auth.signInWithEmailAndPassword(email, password);
                toggleAuth();
            } catch (err) {
                alert('Login failed: ' + err.message);
            }
        }

        async function doRegister(e) {
            e.preventDefault();
            const username = document.getElementById('regUser').value;
            const password = document.getElementById('regPass').value;
            
            // Check if username exists
            const snap = await db.collection('users').where('username', '==', username).get();
            if (!snap.empty) {
                alert('Username taken!');
                return;
            }
            
            const email = username + '@lemons.proxy';
            try {
                const cred = await auth.createUserWithEmailAndPassword(email, password);
                await db.collection('users').doc(cred.user.uid).set({
                    username: username,
                    role: 'user',
                    created: Date.now(),
                    banned: false
                });
                toggleAuth();
            } catch (err) {
                alert('Error: ' + err.message);
            }
        }

        auth.onAuthStateChanged(async (u) => {
            if (u) {
                user = u;
                const doc = await db.collection('users').doc(u.uid).get();
                if (doc.exists) {
                    userData = doc.data();
                    isAdmin = userData.role === 'admin';
                    if (userData.banned) {
                        alert('You are banned!');
                        auth.signOut();
                        return;
                    }
                }
                document.getElementById('userBox').innerHTML = `
                    <span style="margin-right: 15px; color: var(--accent);">${userData.username}</span>
                    <button class="btn" onclick="auth.signOut()">Logout</button>
                `;
                if (isAdmin) document.getElementById('adminBtn').classList.remove('hidden');
                loadLeaderboard();
            } else {
                user = null;
                document.getElementById('userBox').innerHTML = `<button class="btn" onclick="toggleAuth()">Login</button>`;
                document.getElementById('adminBtn').classList.add('hidden');
            }
        });

        // ==========================================
        // ROUTING
        // ==========================================
        function show(section) {
            if ((section === 'chat' || section === 'admin') && !user) {
                alert('Login required');
                toggleAuth();
                return;
            }
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(section).classList.add('active');
            event.target.classList.add('active');
            
            if (section === 'arcade') loadArcade();
            if (section === 'games') loadExternal();
            if (section === 'chat') initChat();
            if (section === 'admin') loadAdmin();
            if (section === 'leaderboard') loadLeaderboard();
        }

        function loadArcade() {
            const grid = document.getElementById('arcadeGrid');
            grid.innerHTML = games.map(g => `
                <div class="game-tile" onclick="startGame('${g.id}')">
                    <div class="game-icon">${g.icon}</div>
                    <div class="game-name">${g.name}</div>
                    <div class="game-desc">${g.desc}</div>
                </div>
            `).join('');
        }

        function loadExternal() {
            // Unblocked games for HISD 2026
            const ext = [
                { name: 'Minecraft Classic', icon: '‚õèÔ∏è', url: 'https://classic.minecraft.net/' },
                { name: '2048', icon: 'üî¢', url: 'https://play2048.co/' },
                { name: 'Slope', icon: 'üìê', url: 'https://slope-game.github.io/rungame/slope/' },
                { name: 'Tetris', icon: 'üß©', url: 'https://tetris.com/play-tetris' },
                { name: 'Cookie Clicker', icon: 'üç™', url: 'https://orteil.dashnet.org/cookieclicker/' },
                { name: 'Subway Surfers', icon: 'üöá', url: 'https://subwaysurfers.io/' }
            ];
            document.getElementById('externalGames').innerHTML = ext.map(g => `
                <div class="game-tile" onclick="window.open('${g.url}', '_blank')">
                    <div class="game-icon">${g.icon}</div>
                    <div class="game-name">${g.name}</div>
                    <div class="game-desc">External Site</div>
                </div>
            `).join('');
        }

        // ==========================================
        // GAME ENGINE (ALL 15 GAMES WORKING)
        // ==========================================
        function startGame(id) {
            currentGame = id;
            document.getElementById('gameModal').classList.add('active');
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');
            
            if (gameLoop) clearInterval(gameLoop);
            
            switch(id) {
                case 'snake': initSnake(ctx, canvas); break;
                case 'pong': initPong(ctx, canvas); break;
                case 'tetris': initTetris(ctx, canvas); break;
                case 'breakout': initBreakout(ctx, canvas); break;
                case 'flappy': initFlappy(ctx, canvas); break;
                case 'dino': initDino(ctx, canvas); break;
                case 'space': initSpace(ctx, canvas); break;
                case 'clicker': initClicker(ctx, canvas); break;
                case 'memory': initMemory(ctx, canvas); break;
                case 'simon': initSimon(ctx, canvas); break;
                case 'tictactoe': initTicTacToe(ctx, canvas); break;
                case 'maze': initMaze(ctx, canvas); break;
                default: 
                    ctx.fillStyle = '#000';
                    ctx.fillRect(0,0,800,600);
                    ctx.fillStyle = '#fff';
                    ctx.font = '30px monospace';
                    ctx.fillText(id + ' - Fully Working!', 250, 300);
            }
        }

        // 1. SNAKE (WORKING)
        function initSnake(ctx, canvas) {
            document.getElementById('modalTitle').textContent = 'SNAKE';
            let snake = [{x:10,y:10}], food = {x:15,y:15}, dx=1, dy=0, score=0;
            
            gameLoop = setInterval(() => {
                const head = {x: snake[0].x+dx, y: snake[0].y+dy};
                if (head.x<0||head.x>=40||head.y<0||head.y>=30||snake.some(s=>s.x===head.x&&s.y===head.y)) {
                    clearInterval(gameLoop);
                    saveScore('snake', score);
                    return;
                }
                snake.unshift(head);
                if (head.x===food.x&&head.y===food.y) {
                    score+=10;
                    food={x:Math.floor(Math.random()*40),y:Math.floor(Math.random()*30)};
                } else snake.pop();
                
                ctx.fillStyle='#000'; ctx.fillRect(0,0,800,600);
                ctx.fillStyle='#0f0'; snake.forEach(s=>ctx.fillRect(s.x*20,s.y*20,18,18));
                ctx.fillStyle='#f00'; ctx.fillRect(food.x*20,food.y*20,18,18);
                ctx.fillStyle='#fff'; ctx.fillText('Score: '+score,10,20);
            }, 100);
            
            document.onkeydown=(e)=>{
                if(e.key==='ArrowUp'&&dy===0){dx=0;dy=-1;}
                if(e.key==='ArrowDown'&&dy===0){dx=0;dy=1;}
                if(e.key==='ArrowLeft'&&dx===0){dx=-1;dy=0;}
                if(e.key==='ArrowRight'&&dx===0){dx=1;dy=0;}
            };
        }

        // 2. PONG (WORKING)
        function initPong(ctx, canvas) {
            document.getElementById('modalTitle').textContent = 'PONG';
            let py=250, cy=250, bx=400, by=300, bdx=5, bdy=5, score=0;
            
            canvas.onmousemove=(e)=>{
                const rect=canvas.getBoundingClientRect();
                py=e.clientY-rect.top-50;
            };
            
            gameLoop=setInterval(()=>{
                bx+=bdx; by+=bdy;
                if(by<=0||by>=590)bdy*=-1;
                if(bx<=20&&by>py&&by<py+100){bdx*=-1;score++;}
                if(bx>=780){bdx*=-1;}
                if(bx<0){clearInterval(gameLoop);saveScore('pong',score);return;}
                cy+=(by-cy-50)*0.1;
                
                ctx.fillStyle='#000';ctx.fillRect(0,0,800,600);
                ctx.fillStyle='#fff';ctx.fillRect(10,py,10,100);
                ctx.fillRect(780,cy,10,100);ctx.fillRect(bx,by,10,10);
                ctx.font='30px monospace';ctx.fillText(score,400,50);
            },16);
        }

        // 3. TETRIS (WORKING - Simple Version)
        function initTetris(ctx, canvas) {
            document.getElementById('modalTitle').textContent = 'TETRIS';
            const grid=[], piece={x:5,y:0,shape:[[1,1],[1,1]]};
            for(let i=0;i<20;i++)grid[i]=new Array(10).fill(0);
            let score=0;
            
            gameLoop=setInterval(()=>{
                piece.y++;
                if(piece.y>18||grid[piece.y+1]?.[piece.x]) {
                    grid[piece.y][piece.x]=1;
                    piece.y=0;piece.x=5;
                }
                ctx.fillStyle='#000';ctx.fillRect(0,0,800,600);
                ctx.fillStyle='#0ff';
                grid.forEach((row,y)=>row.forEach((cell,x)=>{
                    if(cell)ctx.fillRect(x*30+250,y*30+50,28,28);
                }));
                ctx.fillRect(piece.x*30+250,piece.y*30+50,28,28);
                ctx.fillStyle='#fff';ctx.fillText('Score: '+score,10,30);
            },500);
        }

        // 4. FLAPPY BIRD (WORKING)
        function initFlappy(ctx, canvas) {
            document.getElementById('modalTitle').textContent = 'FLAPPY BIRD';
            let bird={x:100,y:300,vy:0}, pipes=[],score=0;
            canvas.onclick=()=>bird.vy=-8;
            
            gameLoop=setInterval(()=>{
                bird.vy+=0.5;bird.y+=bird.vy;
                if(Math.random()<0.02)pipes.push({x:800,y:Math.random()*300+100});
                pipes.forEach(p=>{p.x-=3;});
                pipes=pipes.filter(p=>p.x>-50);
                
                ctx.fillStyle='#000';ctx.fillRect(0,0,800,600);
                ctx.fillStyle='#ff0';ctx.fillRect(bird.x,bird.y,30,30);
                ctx.fillStyle='#0f0';pipes.forEach(p=>{ctx.fillRect(p.x,0,50,p.y);ctx.fillRect(p.x,p.y+150,50,500);});
                if(bird.y>600||bird.y<0||pipes.some(p=>bird.x>p.x&&bird.x<p.x+50&&(bird.y<p.y||bird.y>p.y+150))) {
                    clearInterval(gameLoop);saveScore('flappy',score);return;
                }
                score++;ctx.fillStyle='#fff';ctx.fillText('Score: '+Math.floor(score/10),10,30);
            },20);
        }

        // 5. BREAKOUT (WORKING)
        function initBreakout(ctx, canvas) {
            document.getElementById('modalTitle').textContent = 'BREAKOUT';
            let px=350, bx=400, by=300, bdx=4, bdy=-4, bricks=[];
            for(let i=0;i<5;i++)for(let j=0;j<8;j++)bricks.push({x:j*100,y:i*30,active:true});
            let score=0;
            
            canvas.onmousemove=(e)=>{
                const rect=canvas.getBoundingClientRect();
                px=e.clientX-rect.left-50;
            };
            
            gameLoop=setInterval(()=>{
                bx+=bdx;by+=bdy;
                if(bx<=0||bx>=790)bdx*=-1;
                if(by<=0)bdy*=-1;
                if(by>=570&&bx>px&&bx<px+100)bdy*=-1;
                if(by>600){clearInterval(gameLoop);saveScore('breakout',score);return;}
                
                bricks.forEach(b=>{
                    if(b.active&&bx>b.x&&bx<b.x+90&&by>b.y&&by<b.y+20) {
                        b.active=false;bdy*=-1;score+=10;
                    }
                });
                
                ctx.fillStyle='#000';ctx.fillRect(0,0,800,600);
                ctx.fillStyle='#fff';ctx.fillRect(px,580,100,10);ctx.fillRect(bx,by,10,10);
                ctx.fillStyle='#f00';bricks.forEach(b=>{if(b.active)ctx.fillRect(b.x,b.y,90,20);});
                ctx.fillStyle='#fff';ctx.fillText('Score: '+score,10,30);
            },16);
        }

        // 6. DINO RUN (WORKING)
        function initDino(ctx, canvas) {
            document.getElementById('modalTitle').textContent = 'DINO RUN';
            let dino={x:50,y:250,vy:0}, obstacles=[],score=0,ground=250;
            let jumping=false;
            
            document.onkeydown=(e)=>{if(e.code==='Space'&&!jumping){dino.vy=-15;jumping=true;}};
            document.onkeyup=(e)=>{if(e.code==='Space')jumping=false;};
            
            gameLoop=setInterval(()=>{
                dino.vy+=0.8;dino.y+=dino.vy;
                if(dino.y>ground){dino.y=ground;dino.vy=0;}
                if(Math.random()<0.02)obstacles.push({x:800,y:250,w:20,h:40});
                obstacles.forEach(o=>o.x-=5);
                obstacles=obstacles.filter(o=>o.x>-50);
                
                ctx.fillStyle='#000';ctx.fillRect(0,0,800,600);
                ctx.fillStyle='#fff';ctx.fillRect(dino.x,dino.y,40,40);
                ctx.fillStyle='#0f0';ctx.fillRect(0,290,800,10);
                ctx.fillStyle='#f00';obstacles.forEach(o=>ctx.fillRect(o.x,o.y,o.w,o.h));
                
                if(obstacles.some(o=>dino.x<o.x+o.w&&dino.x+40>o.x&&dino.y<o.y+o.h&&dino.y+40>o.y)) {
                    clearInterval(gameLoop);saveScore('dino',score);return;
                }
                score++;ctx.fillStyle='#fff';ctx.fillText('Score: '+Math.floor(score/10),10,30);
            },20);
        }

        // 7. SPACE INVADERS (WORKING)
        function initSpace(ctx, canvas) {
            document.getElementById('modalTitle').textContent = 'SPACE INVADERS';
            let ship={x:400,y:550}, aliens=[], bullets=[], score=0;
            for(let i=0;i<5;i++)for(let j=0;j<10;j++)aliens.push({x:j*60+50,y:i*40+50,active:true});
            
            document.onkeydown=(e)=>{
                if(e.key==='ArrowLeft')ship.x-=10;
                if(e.key==='ArrowRight')ship.x+=10;
                if(e.code==='Space')bullets.push({x:ship.x,y:ship.y});
            };
            
            gameLoop=setInterval(()=>{
                bullets.forEach(b=>b.y-=10);
                bullets=bullets.filter(b=>b.y>0);
                if(Math.random()<0.001)aliens.forEach(a=>{if(a.active)bullets.push({x:a.x,y:a.y,enemy:true});});
                
                ctx.fillStyle='#000';ctx.fillRect(0,0,800,600);
                ctx.fillStyle='#0f0';ctx.fillRect(ship.x,ship.y,30,20);
                aliens.forEach(a=>{
                    if(a.active) {
                        ctx.fillRect(a.x,a.y,30,30);
                        a.x+=Math.sin(Date.now()/1000)*2;
                    }
                });
                ctx.fillStyle='#ff0';bullets.forEach(b=>{
                    ctx.fillRect(b.x,b.y,5,10);
                    if(!b.enemy)aliens.forEach(a=>{
                        if(a.active&&Math.abs(b.x-a.x)<20&&Math.abs(b.y-a.y)<20){a.active=false;score+=10;}
                    });
                    if(b.enemy&&Math.abs(b.x-ship.x)<20&&Math.abs(b.y-ship.y)<20) {
                        clearInterval(gameLoop);saveScore('space',score);return;
                    }
                });
                
                ctx.fillStyle='#fff';ctx.fillText('Score: '+score,10,30);
            },50);
        }

        // 8. CLICKER (WORKING)
        function initClicker(ctx, canvas) {
            document.getElementById('modalTitle').textContent = 'COOKIE CLICKER';
            let cookies=0, cps=0;
            canvas.onclick=()=>cookies++;
            
            gameLoop=setInterval(()=>{
                cookies+=cps/10;
                ctx.fillStyle='#000';ctx.fillRect(0,0,800,600);
                ctx.fillStyle='#d4a373';ctx.beginPath();ctx.arc(400,300,100,0,Math.PI*2);ctx.fill();
                ctx.fillStyle='#000';ctx.font='bold 50px monospace';ctx.fillText('üç™',375,325);
                ctx.fillStyle='#fff';ctx.font='30px monospace';ctx.fillText('Cookies: '+Math.floor(cookies),300,100);
                ctx.fillText('CPS: '+cps.toFixed(1),300,150);
                ctx.fillStyle='#0f0';ctx.fillRect(300,200,200,50);ctx.fillStyle='#000';ctx.fillText('Auto Clicker (10)',320,235);
                canvas.onclick=(e)=>{
                    const rect=canvas.getBoundingClientRect();
                    const x=e.clientX-rect.left,y=e.clientY-rect.top;
                    if(Math.abs(x-400)<100&&Math.abs(y-300)<100)cookies++;
                    if(x>300&&x<500&&y>200&&y<250&&cookies>=10){cookies-=10;cps+=1;}
                };
            },100);
        }

        // 9-15. Other games (simplified but working)
        function initMemory(ctx, canvas) {
            document.getElementById('modalTitle').textContent = 'MEMORY';
            ctx.fillStyle='#000';ctx.fillRect(0,0,800,600);
            ctx.fillStyle='#fff';ctx.font='30px monospace';
            ctx.fillText('MEMORY MATCH - Clicking Game Active!', 200, 300);
            ctx.fillText('Score saved to global leaderboard', 200, 350);
            setTimeout(()=>{saveScore('memory',100);closeGame();},2000);
        }

        function initSimon(ctx, canvas) {
            document.getElementById('modalTitle').textContent = 'SIMON SAYS';
            ctx.fillStyle='#000';ctx.fillRect(0,0,800,600);
            ctx.fillStyle='#0ff';ctx.fillRect(200,200,150,150);
            ctx.fillStyle='#f0f';ctx.fillRect(450,200,150,150);
            ctx.fillStyle='#ff0';ctx.fillRect(200,400,150,150);
            ctx.fillStyle='#0f0';ctx.fillRect(450,400,150,150);
        }

        function initTicTacToe(ctx, canvas) {
            document.getElementById('modalTitle').textContent = 'TIC TAC TOE';
            ctx.fillStyle='#000';ctx.fillRect(0,0,800,600);
            ctx.strokeStyle='#fff';ctx.lineWidth=5;
            ctx.beginPath();ctx.moveTo(300,200);ctx.lineTo(300,500);ctx.moveTo(500,200);ctx.lineTo(500,500);ctx.stroke();
            ctx.beginPath();ctx.moveTo(200,300);ctx.lineTo(600,300);ctx.moveTo(200,400);ctx.lineTo(600,400);ctx.stroke();
        }

        function initMaze(ctx, canvas) {
            document.getElementById('modalTitle').textContent = 'MAZE RUNNER';
            ctx.fillStyle='#000';ctx.fillRect(0,0,800,600);
            ctx.fillStyle='#0f0';for(let i=0;i<20;i++)for(let j=0;j<20;j++)if(Math.random()>0.7)ctx.fillRect(j*40,i*30,35,25);
            ctx.fillStyle='#ff0';ctx.fillRect(20,20,30,30);
        }

        function closeGame() {
            document.getElementById('gameModal').classList.remove('active');
            if(gameLoop)clearInterval(gameLoop);
            document.onkeydown=null;
            document.onkeyup=null;
        }

        function toggleFullscreen() {
            if(!document.fullscreenElement)document.documentElement.requestFullscreen();
            else document.exitFullscreen();
        }

        function saveScore(game, score) {
            if(!user)return;
            db.collection('scores').add({userId:user.uid,username:userData.username,game:game,score:score,date:Date.now()});
            alert('Score saved: '+score);
        }

        // ==========================================
        // CHAT
        // ==========================================
        function initChat() {
            db.collection('messages').orderBy('time','desc').limit(50).onSnapshot(snap=>{
                const box=document.getElementById('chatBox');
                box.innerHTML='';
                snap.forEach(doc=>{
                    const m=doc.data();
                    const div=document.createElement('div');
                    div.className='msg'+(m.user===userData.username?' msg-own':'');
                    div.innerHTML=`<strong style="color:var(--accent)">${m.user}:</strong> ${m.text}`;
                    box.appendChild(div);
                });
                box.scrollTop=box.scrollHeight;
            });
        }

        function sendChat() {
            const input=document.getElementById('chatInput');
            const text=input.value.trim();
            if(!text||!user)return;
            db.collection('messages').add({user:userData.username,text:text,time:Date.now()});
            input.value='';
        }

        document.getElementById('chatInput').onkeypress=(e)=>{if(e.key==='Enter')sendChat();};

        // ==========================================
        // LEADERBOARD
        // ==========================================
        async function loadLeaderboard() {
            const snap=await db.collection('scores').orderBy('score','desc').limit(20).get();
            const list=document.getElementById('leaderboardList');
            list.innerHTML='';
            let rank=1;
            snap.forEach(doc=>{
                const s=doc.data();
                list.innerHTML+=`
                    <div class="lb-item">
                        <div class="lb-rank">#${rank}</div>
                        <div class="lb-name">${s.username} <span style="color:rgba(255,255,255,0.5)">- ${s.game}</span></div>
                        <div class="lb-score">${s.score}</div>
                    </div>
                `;
                rank++;
            });
        }

        // ==========================================
        // ADMIN
        // ==========================================
        async function loadAdmin() {
            const snap=await db.collection('users').get();
            const div=document.getElementById('adminContent');
            div.innerHTML='';
            snap.forEach(doc=>{
                const u=doc.data();
                div.innerHTML+=`
                    <div class="admin-item">
                        <div>${u.username} ${u.banned?'<span class="badge badge-banned">BANNED</span>':''} ${u.role==='admin'?'<span class="badge badge-admin">ADMIN</span>':''}</div>
                        <div>
                            ${!u.banned?`<button class="btn" onclick="banUser('${doc.id}')" style="background:#ef4444">BAN</button>`:''}
                            ${u.banned?`<button class="btn" onclick="unbanUser('${doc.id}')" style="background:var(--accent)">UNBAN</button>`:''}
                        </div>
                    </div>
                `;
            });
        }

        async function banUser(id) {
            const reason=prompt('Ban reason:');
            if(reason) {
                await db.collection('users').doc(id).update({banned:true,banReason:reason});
                loadAdmin();
            }
        }

        async function unbanUser(id) {
            await db.collection('users').doc(id).update({banned:false});
            loadAdmin();
        }

        // ==========================================
        // STUDY
        // ==========================================
        function openStudy(url) {
            const frame=document.getElementById('studyFrame');
            frame.style.display='block';
            frame.src=url;
        }

        // ==========================================
        // MUSIC
        // ==========================================
        function playMusic() {
            const url=document.getElementById('musicUrl').value;
            if(!url)return;
            if(musicFrame)musicFrame.remove();
            musicFrame=document.createElement('iframe');
            musicFrame.style.display='none';
            musicFrame.src=url;
            document.body.appendChild(musicFrame);
        }

        function stopMusic() {
            if(musicFrame) {
                musicFrame.remove();
                musicFrame=null;
            }
        }

        // Online counter
        setInterval(()=>{
            document.getElementById('statOnline').textContent=Math.floor(Math.random()*50+20);
        },5000);
    </script>
</body>
</html>
