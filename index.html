<script>
// Complete the achievements array
const achievements = [
  {id: "first_launch", name: "System Init", desc: "Boot up Lemons Proxy", icon: "ðŸ–¥ï¸", unlocked: false},
  {id: "first_game", name: "Module Runner", desc: "Launch your first game", icon: "ðŸŽ®", unlocked: false},
  {id: "ten_games", name: "Power User", desc: "Launch 10 different games", icon: "âš¡", unlocked: false},
  {id: "search_try", name: "Network Scout", desc: "Visit the proxy tab", icon: "ðŸ”", unlocked: false},
  {id: "fullscreen", name: "Maximum Overdrive", desc: "Use fullscreen mode", icon: "â›¶", unlocked: false},
  {id: "konami", name: "Code Breaker", desc: "Enter the Konami Code", icon: "ðŸ”“", unlocked: false},
  {id: "logo_clicker", name: "Curious Mind", desc: "Click the logo 5 times", icon: "ðŸ‹", unlocked: false},
  {id: "aurelio_search", name: "Hidden Truth", desc: "Search for the forbidden name", icon: "ðŸš«", unlocked: false}
];

// State management
let gamesLaunched = [];
let logoClicks = 0;
let konamiSequence = [];
let musicPlaying = false;
let achievementsUnlocked = [];

// Konami code: â†‘â†‘â†“â†“â†â†’â†â†’BA
const konamiCode = ['ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'ArrowLeft', 'ArrowRight', 'b', 'a'];

// Efficient initialization
document.addEventListener('DOMContentLoaded', () => {
  renderGames();
  renderAchievements();
  updateStats();
  checkFirstLaunch();
  
  // Keyboard listener for Konami and search easter egg
  document.addEventListener('keydown', handleKeydown);
  
  // Console easter egg
  console.log('%c fuck you aurelio ', 'background: #1e3a8a; color: #3b82f6; font-size: 20px; font-family: monospace; border: 2px solid #3b82f6; padding: 10px;');
  console.log('%c Lemons Proxy v10.0 // LD x Lemonwesh ', 'color: #60a5fa; font-family: monospace;');
});

function handleKeydown(e) {
  // Konami code detection
  konamiSequence.push(e.key);
  if (konamiSequence.length > 10) konamiSequence.shift();
  
  if (konamiSequence.join(',') === konamiCode.join(',')) {
    unlockAchievement('konami');
    showEasterEggToast("ðŸ”“ KONAMI CODE ACTIVATED\nSystem restrictions bypassed.\nAll modules unlocked.");
    document.body.style.filter = "hue-rotate(180deg)";
    setTimeout(() => document.body.style.filter = "", 3000);
  }
}

function dismissBoot() {
  document.getElementById('boot-sequence').style.display = 'none';
  playDystopianMusic();
  unlockAchievement('first_launch');
}

function playDystopianMusic() {
  // Auto-play dystopian ambient music using YouTube iframe API workaround
  const container = document.getElementById('musicContainer');
  const videoId = 'JvF3ps2JiYY'; // Dystopian ambient track
  
  // Create invisible iframe for autoplay (muted workaround for browser policies)
  container.innerHTML = `
    <iframe 
      width="0" 
      height="0" 
      src="https://www.youtube.com/embed/${videoId}?autoplay=1&loop=1&playlist=${videoId}&mute=1" 
      frameborder="0" 
      allow="autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
      allowfullscreen>
    </iframe>
  `;
  
  // Try to unmute after user interaction (click)
  setTimeout(() => {
    const iframes = container.getElementsByTagName('iframe');
    if (iframes.length > 0) {
      // Replace with unmuted version
      iframes[0].src = `https://www.youtube.com/embed/${videoId}?autoplay=1&loop=1&playlist=${videoId}&mute=0`;
    }
    musicPlaying = true;
    document.getElementById('nowPlaying').textContent = 'â™« Now Playing: Dystopian Ambient';
  }, 1000);
}

function playMusic() {
  const url = document.getElementById('musicUrl').value;
  const container = document.getElementById('musicContainer');
  const videoId = extractVideoID(url);
  
  if (videoId) {
    container.innerHTML = `
      <iframe 
        width="0" 
        height="0" 
        src="https://www.youtube.com/embed/${videoId}?autoplay=1&loop=1&playlist=${videoId}" 
        frameborder="0" 
        allow="autoplay; clipboard-write; encrypted-media" 
        allowfullscreen>
      </iframe>
    `;
    musicPlaying = true;
    document.getElementById('nowPlaying').textContent = 'â™« Custom Track Active';
    document.getElementById('nowPlaying').classList.add('active');
  }
}

function stopMusic() {
  document.getElementById('musicContainer').innerHTML = '';
  musicPlaying = false;
  document.getElementById('nowPlaying').textContent = 'â™« Audio Stopped';
}

function extractVideoID(url) {
  const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
  const match = url.match(regExp);
  return (match && match[2].length === 11) ? match[2] : null;
}

function renderGames() {
  const grid = document.getElementById('gamesGrid');
  grid.innerHTML = games.map((game, index) => `
    <div class="game-module" onclick="launchGame('${game.url}', '${game.name}')" data-name="${game.name.toLowerCase()}">
      <div class="module-header">
        <span class="module-icon">${game.emoji}</span>
        <span class="module-tag">${game.tag}</span>
      </div>
      <div class="module-title">${game.name}</div>
      <div class="module-meta">
        <span>v1.0.${index}</span>
        <span>${game.size}MB</span>
      </div>
    </div>
  `).join('');
}

function launchGame(url, name) {
  const viewer = document.getElementById('gameViewer');
  const frame = document.getElementById('gameFrame');
  const title = document.getElementById('viewerTitle');
  
  title.textContent = name.toUpperCase();
  frame.src = url;
  viewer.classList.add('active');
  
  // Track for achievements
  if (!gamesLaunched.includes(name)) {
    gamesLaunched.push(name);
    if (gamesLaunched.length === 1) unlockAchievement('first_game');
    if (gamesLaunched.length === 10) unlockAchievement('ten_games');
  }
  
  // Update module count display
  document.getElementById('moduleCount').textContent = '45';
}

function closeGame() {
  const viewer = document.getElementById('gameViewer');
  const frame = document.getElementById('gameFrame');
  viewer.classList.remove('active');
  frame.src = '';
}

function toggleFullscreen() {
  const frame = document.getElementById('gameFrame');
  if (frame.requestFullscreen) {
    frame.requestFullscreen();
    unlockAchievement('fullscreen');
  }
}

function showSection(section) {
  document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
  document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
  
  document.getElementById(section).classList.add('active');
  document.getElementById('nav-' + section).classList.add('active');
  
  if (section === 'search') unlockAchievement('search_try');
}

function searchGames() {
  const input = document.getElementById('searchInput').value.toLowerCase();
  const modules = document.querySelectorAll('.game-module');
  
  // Easter egg: search for "aurelio"
  if (input === 'aurelio') {
    unlockAchievement('aurelio_search');
    showEasterEggToast("ðŸš« ACCESS DENIED\nUser 'Aurelio' blacklisted from system.\nReason: Unauthorized access attempts.");
  }
  
  modules.forEach(module => {
    const name = module.getAttribute('data-name');
    module.style.display = name.includes(input) ? 'block' : 'none';
  });
}

function easterEggLogo() {
  logoClicks++;
  if (logoClicks === 5) {
    unlockAchievement('logo_clicker');
    showEasterEggToast("ðŸ‹ LEMON PROTOCOL ACTIVATED\nCitrus levels critical.\nSystem optimized for acidity.");
  }
  
  // Visual feedback
  const logo = document.querySelector('.logo-icon');
  logo.style.transform = `rotate(${logoClicks * 15}deg) scale(${1 + logoClicks * 0.1})`;
  setTimeout(() => logo.style.transform = '', 300);
}

function unlockAchievement(id) {
  const ach = achievements.find(a => a.id === id);
  if (ach && !ach.unlocked && !achievementsUnlocked.includes(id)) {
    ach.unlocked = true;
    achievementsUnlocked.push(id);
    renderAchievements();
    showAchievementPopup(ach);
    updateStats();
    
    // Save to localStorage for persistence
    localStorage.setItem('lemons_achievements', JSON.stringify(achievementsUnlocked));
  }
}

function checkFirstLaunch() {
  const saved = localStorage.getItem('lemons_achievements');
  if (saved) {
    achievementsUnlocked = JSON.parse(saved);
    achievementsUnlocked.forEach(id => {
      const ach = achievements.find(a => a.id === id);
      if (ach) ach.unlocked = true;
    });
    renderAchievements();
    updateStats();
  }
}

function renderAchievements() {
  const list = document.getElementById('achievementsList');
  const progress = document.getElementById('ach-progress');
  
  list.innerHTML = achievements.map(ach => `
    <div class="achievement-item ${ach.unlocked ? 'unlocked' : ''}">
      <div class="achievement-icon">${ach.icon}</div>
      <div class="achievement-info">
        <h4>${ach.name}</h4>
        <p>${ach.desc}</p>
      </div>
    </div>
  `).join('');
  
  const unlockedCount = achievements.filter(a => a.unlocked).length;
  progress.textContent = `${unlockedCount}/${achievements.length}`;
  document.getElementById('achievements-count').textContent = `${unlockedCount}/${achievements.length}`;
}

function showAchievementPopup(ach) {
  const popup = document.getElementById('achievementPopup');
  document.getElementById('pop-achievement-text').textContent = ach.name;
  popup.classList.add('show');
  setTimeout(() => popup.classList.remove('show'), 4000);
}

function toggleAchievements() {
  document.getElementById('achievementsPanel').classList.toggle('active');
}

function showEasterEggToast(message) {
  const toast = document.getElementById('easterToast');
  toast.textContent = message;
  toast.classList.add('show');
  setTimeout(() => toast.classList.remove('show'), 5000);
}

function updateStats() {
  // Simulate dynamic latency
  setInterval(() => {
    const latency = Math.floor(Math.random() * 20) + 8;
    const el = document.getElementById('latency');
    if (el) el.textContent = latency + 'ms';
  }, 5000);
}

// Prevent memory leaks - cleanup on page unload
window.addEventListener('beforeunload', () => {
  stopMusic();
});
</script>
</body>
</html>
